<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Voice Interviewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .pulse {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 1);
        animation: pulse-red 2s infinite;
      }
      @keyframes pulse-red {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-12"
  >
    <div
      class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8 space-y-6"
    >
      <!-- Header -->
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900">AI Voice Interviewer</h1>
        <p class="text-gray-500 mt-1">
          Practice your interview skills in real-time.
        </p>
      </div>

      <!-- Setup Form -->
      <div id="setup-form" class="space-y-4">
        <div>
          <label
            for="n8n-webhook-url"
            class="block text-sm font-medium text-gray-700"
            >n8n Webhook URL</label
          >
          <input
            type="url"
            id="n8n-webhook-url"
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Paste your Production URL here"
          />
        </div>
        <div>
          <label for="job-title" class="block text-sm font-medium text-gray-700"
            >Job Title</label
          >
          <input
            type="text"
            id="job-title"
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="e.g., Senior Software Engineer"
          />
        </div>
        <div>
          <label
            for="job-description"
            class="block text-sm font-medium text-gray-700"
            >Job Description</label
          >
          <textarea
            id="job-description"
            rows="4"
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Paste the job description here..."
          ></textarea>
        </div>
        <div>
          <label
            for="resume-text"
            class="block text-sm font-medium text-gray-700"
            >Resume Text</label
          >
          <textarea
            id="resume-text"
            rows="6"
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Open your resume, copy all the text, and paste it here..."
          ></textarea>
        </div>
        <button
          id="start-interview-btn"
          class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300"
        >
          Start Interview
        </button>
      </div>

      <!-- Interview UI -->
      <div id="interview-ui" class="hidden space-y-4">
        <div
          id="conversation-log"
          class="h-64 overflow-y-auto p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-4"
        >
          <!-- Messages will be appended here -->
        </div>
        <div class="text-center">
          <p id="status-text" class="text-gray-500 h-6">
            Press the button and start speaking.
          </p>
        </div>
        <div class="flex justify-center items-center">
          <button
            id="record-btn"
            class="w-20 h-20 bg-red-500 text-white rounded-full flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>
      <!-- Loading Spinner -->
      <div id="loading-spinner" class="hidden items-center justify-center p-8">
        <div
          class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600"
        ></div>
        <p class="ml-4 text-lg text-gray-600">AI is thinking...</p>
      </div>
    </div>

    <script>
      // --- DOM Elements ---
      const setupForm = document.getElementById("setup-form");
      const interviewUI = document.getElementById("interview-ui");
      const startInterviewBtn = document.getElementById("start-interview-btn");
      const recordBtn = document.getElementById("record-btn");
      const statusText = document.getElementById("status-text");
      const conversationLog = document.getElementById("conversation-log");
      const loadingSpinner = document.getElementById("loading-spinner");

      // --- State Variables ---
      let n8nWebhookUrl = "";
      let jobTitle = "";
      let jobDescription = "";
      let conversationHistory = "";
      let lastQuestion = "";
      let isRecording = false;

      // --- Speech Recognition & Synthesis Setup ---
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = SpeechRecognition ? new SpeechRecognition() : null;
      if (recognition) {
        recognition.continuous = false;
        recognition.lang = "en-US";
        recognition.interimResults = false;
      }

      const synth = window.speechSynthesis;

      // --- Event Listeners ---
      startInterviewBtn.addEventListener("click", startInterview);
      recordBtn.addEventListener("click", toggleRecording);

      if (recognition) {
        recognition.onresult = handleRecognitionResult;
        recognition.onerror = handleRecognitionError;
        recognition.onstart = () => {
          isRecording = true;
          statusText.textContent = "Listening...";
          recordBtn.classList.add("pulse");
          recordBtn.classList.remove("bg-red-500");
          recordBtn.classList.add("bg-red-600");
        };
        recognition.onend = () => {
          isRecording = false;
          statusText.textContent = "Processing your answer...";
          recordBtn.classList.remove("pulse");
          recordBtn.classList.remove("bg-red-600");
          recordBtn.classList.add("bg-red-500");
        };
      } else {
        statusText.textContent =
          "Speech recognition not supported in this browser.";
        recordBtn.disabled = true;
      }

      // --- Core Functions ---

      async function startInterview() {
        n8nWebhookUrl = document.getElementById("n8n-webhook-url").value;
        jobTitle = document.getElementById("job-title").value;
        jobDescription = document.getElementById("job-description").value;
        const resumeText = document.getElementById("resume-text").value;

        if (!n8nWebhookUrl || !jobTitle || !jobDescription || !resumeText) {
          alert("Please fill out all fields and paste your resume text.");
          return;
        }

        setLoading(true);
        setupForm.classList.add("hidden");

        const initialData = { jobTitle, jobDescription, resumeText };

        try {
          const response = await fetch(n8nWebhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(initialData),
          });

          if (!response.ok) {
            throw new Error(
              `Network response was not ok: ${response.statusText}`,
            );
          }

          const data = await response.json();
          handleNewQuestion(data);
          setLoading(false);
          interviewUI.classList.remove("hidden");
        } catch (error) {
          console.error("Error starting interview:", error);
          alert(
            `Failed to start interview. Check the webhook URL and n8n workflow.\nError: ${error.message}`,
          );
          setLoading(false);
          setupForm.classList.remove("hidden");
        }
      }

      function toggleRecording() {
        if (!recognition) return;
        if (isRecording) {
          recognition.stop();
        } else {
          recognition.start();
        }
      }

      function handleRecognitionResult(event) {
        const userAnswer = event.results[0][0].transcript;
        addMessageToLog("You", userAnswer);
        sendAnswerToN8n(userAnswer);
      }

      function handleRecognitionError(event) {
        console.error("Speech recognition error:", event.error);
        statusText.textContent = `Error: ${event.error}. Please try again.`;
        isRecording = false;
      }

      async function sendAnswerToN8n(answerText) {
        setLoading(true);
        interviewUI.classList.add("hidden");

        const payload = {
          jobTitle,
          jobDescription,
          conversationHistory,
          lastQuestion,
          answer: answerText,
        };

        try {
          const response = await fetch(n8nWebhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(
              `Network response was not ok: ${response.statusText}`,
            );
          }

          const data = await response.json();
          handleNewQuestion(data);
        } catch (error) {
          console.error("Error sending answer:", error);
          alert(`Failed to get next question. Error: ${error.message}`);
        } finally {
          setLoading(false);
          interviewUI.classList.remove("hidden");
        }
      }

      function handleNewQuestion(data) {
        const question = data.question;
        lastQuestion = question;
        conversationHistory = data.conversationHistory;

        addMessageToLog("Interviewer", question);
        speakText(question);
        statusText.textContent = "Press the button to answer.";
      }

      function speakText(text) {
        if (synth.speaking) {
          synth.cancel();
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.onerror = (event) =>
          console.error("Speech synthesis error:", event);
        synth.speak(utterance);
      }

      function addMessageToLog(speaker, message) {
        const isUser = speaker === "You";
        const messageDiv = document.createElement("div");

        // ** THE FIX IS HERE **
        messageDiv.classList.add("flex", "items-start", "gap-2.5");
        if (isUser) {
          messageDiv.classList.add("justify-end");
        }
        // ** END OF FIX **

        const contentDiv = document.createElement("div");
        contentDiv.classList.add(
          "flex",
          "flex-col",
          "w-full",
          "max-w-[480px]",
          "leading-1.5",
          "p-4",
          "border-gray-200",
          isUser ? "bg-indigo-500" : "bg-gray-100",
          "rounded-e-xl",
          "rounded-es-xl",
        );

        const speakerP = document.createElement("p");
        speakerP.classList.add(
          "text-sm",
          "font-semibold",
          isUser ? "text-white" : "text-gray-900",
        );
        speakerP.textContent = speaker;

        const messageP = document.createElement("p");
        messageP.classList.add(
          "text-sm",
          "font-normal",
          "py-2.5",
          isUser ? "text-white" : "text-gray-900",
        );
        messageP.textContent = message;

        contentDiv.appendChild(speakerP);
        contentDiv.appendChild(messageP);
        messageDiv.appendChild(contentDiv);

        conversationLog.appendChild(messageDiv);
        conversationLog.scrollTop = conversationLog.scrollHeight;
      }

      function setLoading(isLoading) {
        if (isLoading) {
          loadingSpinner.classList.remove("hidden");
          loadingSpinner.classList.add("flex");
        } else {
          loadingSpinner.classList.add("hidden");
          loadingSpinner.classList.remove("flex");
        }
      }
    </script>
  </body>
</html>
